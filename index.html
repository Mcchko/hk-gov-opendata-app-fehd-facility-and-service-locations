<!DOCTYPE html>
<html lang="zh-Hant">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>「食環署的設施及服務位置」查詢系統</title>
    <!-- Awesome Icon -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.1/css/all.min.css" />
    <!-- Leaflet CSS for Maps -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        .element-hidden {
            display: none !important;
        }

        /* Reset & Base */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
            background: linear-gradient(135deg, #0f766e 0%, #14b8a6 100%);
            min-height: 100vh;
            padding: 16px;
            color: #1f2937;
        }

        /* Layout */
        .container {
            max-width: 1600px;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            gap: 20px;
            min-height: 100vh;
        }

        /* Header */
        .header {
            background: rgba(255, 255, 255, 0.95);
            padding: 20px;
            border-radius: 16px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .header h1 {
            color: #111827;
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 8px;
            background: linear-gradient(135deg, #0f766e 0%, #14b8a6 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-align: center;
        }

        .header .subtitle {
            color: #6b7280;
            font-size: 1rem;
            line-height: 1.5;
            text-align: center;
        }

        /* Form Section */
        .form-section {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 16px;
            padding: 25px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            margin-bottom: 8px;
            font-weight: 600;
            color: #374151;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .form-group label i {
            color: #14b8a6;
        }

        .form-control {
            padding: 12px 16px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 1rem;
            transition: all 0.2s ease;
            background: white;
        }

        .form-control:focus {
            outline: none;
            border-color: #14b8a6;
            box-shadow: 0 0 0 3px rgba(20, 184, 166, 0.1);
        }

        .form-actions {
            display: grid;
            gap: 12px;
            justify-content: start;
            margin-top: 10px;
        }

        .btn {
            padding: 12px 28px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #14b8a6 0%, #0f766e 100%);
            color: white;
        }

        .btn-primary:hover {
            background: linear-gradient(135deg, #0d9488 0%, #0f766e 100%);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(13, 148, 136, 0.3);
        }

        .btn-secondary {
            background: #f3f4f6;
            color: #374151;
            border: 1px solid #d1d5db;
        }

        .btn-secondary:hover {
            background: #e5e7eb;
            transform: translateY(-2px);
        }

        .btn-danger {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
        }

        .btn-danger:hover {
            background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(220, 38, 38, 0.3);
        }

        .cache-info {
            background: #fef3c7;
            border-radius: 8px;
            padding: 12px;
            margin-top: 15px;
            border: 1px solid #fbbf24;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .cache-info-content {
            color: #92400e;
            font-size: 0.9rem;
        }

        .cache-info-actions {
            display: flex;
            gap: 8px;
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 0.85rem;
        }

        /* Main Content */
        .main-content {
            display: flex;
            flex: 1;
            gap: 20px;
            height: 70vh;
        }

        .data-section {
            flex: 1;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 16px;
            padding: 20px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            overflow-y: auto;
            max-height: 100%;
        }

        .map-section {
            flex: 1;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 16px;
            padding: 20px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            display: flex;
            flex-direction: column;
            min-height: 100%;
        }

        .map-container {
            flex: 1;
            border-radius: 8px;
            overflow: hidden;
            border: 2px solid #e5e7eb;
        }

        #map {
            width: 100%;
            min-height: 350px;
        }

        /* Data Section Styles */
        .data-header {
            margin-bottom: 20px;
            text-align: center;
        }

        .data-header h2 {
            color: #111827;
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 8px;
            background: linear-gradient(135deg, #0f766e 0%, #14b8a6 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .data-header .subtitle {
            color: #6b7280;
            font-size: 0.9rem;
            line-height: 1.5;
        }

        .data-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            background: #f8fafc;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 20px;
            border: 1px solid #e5e7eb;
        }

        .stat-item {
            text-align: center;
        }

        .stat-value {
            font-size: 1.8rem;
            font-weight: 700;
            color: #14b8a6;
            display: block;
        }

        .stat-label {
            font-size: 0.8rem;
            color: #6b7280;
        }

        .accordion-container {
            margin-top: 20px;
        }

        .facility-group {
            background: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            margin-bottom: 16px;
            overflow: hidden;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .facility-group:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .facility-header {
            background: linear-gradient(135deg, #14b8a6 0%, #0f766e 100%);
            color: white;
            padding: 15px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 600;
            border-bottom: 1px solid #e5e7eb;
        }

        .facility-header.active {
            background: linear-gradient(135deg, #0d9488 0%, #115e59 100%);
        }

        .facility-header i {
            transition: transform 0.3s ease;
        }

        .facility-header.collapsed i {
            transform: rotate(-90deg);
        }

        .facility-content {
            padding: 20px;
            background: white;
        }

        .facility-list {
            display: grid;
            gap: 12px;
        }

        .facility-item {
            background: #f8fafc;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 15px;
            transition: all 0.2s ease;
            cursor: pointer;
        }

        .facility-item:hover {
            background: #f1f5f9;
            border-color: #14b8a6;
        }

        .facility-item.selected {
            background: #ecfdf5;
            border-color: #10b981;
            box-shadow: 0 0 0 2px rgba(16, 185, 129, 0.2);
        }

        .facility-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 10px;
        }

        .facility-row {
            display: flex;
            margin-bottom: 8px;
            padding-bottom: 8px;
            border-bottom: 1px solid #f3f4f6;
        }

        .facility-label {
            font-weight: 600;
            color: #374151;
            width: 120px;
            flex-shrink: 0;
        }

        .facility-value {
            flex: 1;
            color: #6b7280;
            word-break: break-word;
        }

        .facility-badge {
            display: inline-flex;
            align-items: center;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            margin-right: 8px;
            margin-bottom: 8px;
        }

        .badge-district {
            background: #d1fae5;
            color: #065f46;
        }

        .badge-type {
            background: #dcfce7;
            color: #166534;
        }

        .badge-phone {
            background: #dbeafe;
            color: #1e40af;
        }

        .badge-hours {
            background: #fef3c7;
            color: #92400e;
        }

        .badge-cached {
            background: #f3e8ff;
            color: #5b21b6;
        }

        .facility-meta {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 12px;
        }

        .no-data {
            text-align: center;
            padding: 40px 20px;
            color: #9ca3af;
        }

        .no-data i {
            font-size: 3rem;
            margin-bottom: 15px;
            opacity: 0.5;
        }

        .loading {
            text-align: center;
            padding: 40px 20px;
            color: #6b7280;
        }

        .loading-spinner {
            border: 3px solid #f3f4f6;
            border-top: 3px solid #14b8a6;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .map-header {
            margin-bottom: 15px;
            text-align: center;
        }

        .map-header h2 {
            color: #111827;
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 8px;
            background: linear-gradient(135deg, #0f766e 0%, #14b8a6 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .map-header .subtitle {
            color: #6b7280;
            font-size: 0.9rem;
            line-height: 1.5;
        }

        .map-info {
            background: #f8fafc;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
            border: 1px solid #e5e7eb;
        }

        .map-info h3 {
            color: #111827;
            margin-bottom: 10px;
            font-size: 1.1rem;
        }

        .map-info-content {
            font-size: 0.9rem;
            color: #6b7280;
        }

        /* Footer */
        .footer {
            text-align: center;
            color: rgba(255, 255, 255, 0.9);
            font-size: 0.875rem;
            padding: 20px;
            margin-top: auto;
        }

        /* Notification */
        .notification {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 12px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            display: flex;
            align-items: center;
            gap: 10px;
            z-index: 3000;
            animation: slideIn 0.3s ease-out;
        }

        .notification.success {
            background-color: #10b981;
            color: white;
        }

        .notification.error {
            background-color: #ef4444;
            color: white;
        }

        .notification.info {
            background-color: #14b8a6;
            color: white;
        }

        .notification.warning {
            background-color: #f59e0b;
            color: white;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }

            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideOut {
            from {
                transform: translateX(0);
                opacity: 1;
            }

            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }

        /* Mobile Optimizations */
        @media (max-width: 768px) {
            body {
                padding: 12px;
                background: #0f766e;
            }

            .container {
                gap: 16px;
            }

            .header {
                padding: 16px;
                border-radius: 12px;
            }

            .header h1 {
                font-size: 1.5rem;
            }

            .form-grid {
                grid-template-columns: 1fr;
                gap: 15px;
            }

            .form-section {
                padding: 20px;
            }

            .main-content {
                flex-direction: column;
                height: auto;
            }

            .data-section {
                max-height: 400px;
                padding: 15px;
            }

            .map-section {
                min-height: 400px;
                padding: 15px;
            }

            .data-header h2 {
                font-size: 1.3rem;
            }

            .map-header h2 {
                font-size: 1.3rem;
            }

            .stat-value {
                font-size: 1.5rem;
            }

            .facility-info {
                grid-template-columns: 1fr;
            }

            .facility-row {
                flex-direction: column;
                margin-bottom: 12px;
            }

            .facility-label {
                width: 100%;
                margin-bottom: 5px;
            }

            .facility-header {
                padding: 12px;
                font-size: 0.9rem;
            }

            .btn {
                padding: 10px 20px;
                font-size: 0.9rem;
            }

            .cache-info {
                flex-direction: column;
                gap: 10px;
                align-items: flex-start;
            }

            .cache-info-actions {
                width: 100%;
                justify-content: flex-end;
            }
        }

        /* Desktop Enhancements */
        @media (min-width: 1200px) {
            .data-section {
                max-height: 70vh;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <header class="header">
            <h1>「食環署的設施及服務位置」查詢系統</h1>
            <p class="subtitle">食物環境衞生署設施及服務位置查詢</p>
        </header>

        <section class="form-section">
            <div class="form-actions">
                <button type="button" class="btn btn-primary" onclick="loadFEHDData()" id="loadDataBtn">
                    <i class="fas fa-download"></i>
                    載入食環署設施資料
                </button>
                <button type="button" class="btn btn-secondary" onclick="clearData()">
                    <i class="fas fa-redo"></i>
                    清除資料
                </button>
                <button type="button" class="btn btn-secondary" onclick="zoomToHongKong()">
                    <i class="fas fa-search-location"></i>
                    全覽香港
                </button>
                <button type="button" class="btn btn-danger" onclick="clearCache()">
                    <i class="fas fa-trash-alt"></i>
                    清除緩存
                </button>
            </div>

            <div class="cache-info" id="cacheInfo" style="display: none;">
                <div class="cache-info-content">
                    <i class="fas fa-database"></i>
                    <span id="cacheStatus">正在檢查緩存...</span>
                </div>
                <div class="cache-info-actions">
                    <button type="button" class="btn btn-secondary btn-small" onclick="loadFromCache()">
                        <i class="fas fa-cloud-download-alt"></i>
                        從緩存載入
                    </button>
                </div>
            </div>
        </section>

        <main class="main-content">
            <section class="data-section">
                <div class="data-header">
                    <h2>食環署設施列表</h2>
                    <p class="subtitle">點擊地區或設施類型查看詳細資訊，點擊設施在地圖上顯示位置</p>
                </div>
                <div class="data-stats">
                    <div class="stat-item">
                        <span id="total-facilities" class="stat-value">0</span>
                        <span class="stat-label">設施總數</span>
                    </div>
                    <div class="stat-item">
                        <span id="total-districts" class="stat-value">0</span>
                        <span class="stat-label">地區數目</span>
                    </div>
                    <div class="stat-item">
                        <span id="total-types" class="stat-value">0</span>
                        <span class="stat-label">設施類型</span>
                    </div>
                    <div class="stat-item">
                        <span id="cache-size" class="stat-value">0 KB</span>
                        <span class="stat-label">緩存大小</span>
                    </div>
                </div>
                <div class="accordion-container" id="accordion-container">
                    <div class="no-data">
                        <i class="fas fa-building"></i>
                        <p>請點擊「載入食環署設施資料」按鈕開始查詢</p>
                    </div>
                </div>
            </section>

            <section class="map-section">
                <div class="map-header">
                    <h2>設施位置地圖</h2>
                    <p class="subtitle">點擊列表中設施查看在地圖上的位置</p>
                </div>
                <div class="map-container">
                    <div id="map"></div>
                </div>
                <div class="map-info" id="map-info">
                    <h3>地圖提示</h3>
                    <div class="map-info-content">
                        等待載入資料... 點擊左側列表中的設施會在地圖上顯示其位置。
                    </div>
                </div>
            </section>
        </main>

        <footer class="footer">
            <p>「食環署的設施及服務位置」查詢系統<br />資料來源: 香港特別行政區政府 食物環境衞生署<span id="last-updated" hidden></span></p>
            <hr style="margin-top:5px;margin-bottom:5px" />
            <p style="font-size: 0.75rem; margin-top: 5px; opacity: 0.8;">使用 IndexedDB 緩存技術 | 緩存有效期: 24小時</p>
        </footer>
    </div>

    <!-- Leaflet JS for Maps -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // IndexedDB 配置
        const DB_NAME = 'FEHD_Facility_DB';
        const DB_VERSION = 1;
        const STORE_NAME = 'facilities';
        const CACHE_KEY = 'fehd_facilities_data';
        const CACHE_TTL = 24 * 60 * 60 * 1000; // 24小時緩存有效期

        // 全局變量
        let fehdData = [];
        let districtsSet = new Set();
        let typesSet = new Set();
        let map = null;
        let currentMarker = null;
        let markerLayer = null;
        let db = null;
        const DATA_URL = 'https://portal.csdi.gov.hk/server/services/common/fehd_rcd_1629969687926_30590/MapServer/WFSServer?service=wfs&request=GetFeature&typenames=FEHD_FACI&outputFormat=geojson';

        // 初始化應用
        document.addEventListener('DOMContentLoaded', function () {
            initializeMap();
            initializeIndexedDB();
            updateLastUpdatedTime();
        });

        // 初始化 IndexedDB
        function initializeIndexedDB() {
            const request = indexedDB.open(DB_NAME, DB_VERSION);

            request.onerror = function (event) {
                console.error('IndexedDB 初始化失敗:', event.target.error);
                showNotification('瀏覽器資料庫初始化失敗，部分功能可能受限', 'warning');
            };

            request.onsuccess = function (event) {
                db = event.target.result;
                console.log('IndexedDB 初始化成功');
                checkCacheStatus();
            };

            request.onupgradeneeded = function (event) {
                db = event.target.result;

                // 創建物件存儲
                if (!db.objectStoreNames.contains(STORE_NAME)) {
                    const objectStore = db.createObjectStore(STORE_NAME, { keyPath: 'key' });

                    // 創建索引以便查詢
                    objectStore.createIndex('timestamp', 'timestamp', { unique: false });
                    objectStore.createIndex('size', 'size', { unique: false });

                    console.log('IndexedDB 物件存儲創建成功');
                }
            };
        }

        // 檢查緩存狀態
        async function checkCacheStatus() {
            if (!db) return;

            const transaction = db.transaction([STORE_NAME], 'readonly');
            const store = transaction.objectStore(STORE_NAME);
            const request = store.get(CACHE_KEY);

            request.onsuccess = function (event) {
                const cachedData = event.target.result;
                const cacheInfo = document.getElementById('cacheInfo');

                if (cachedData && cachedData.timestamp) {
                    const cacheAge = Date.now() - cachedData.timestamp;
                    const isExpired = cacheAge > CACHE_TTL;
                    const cacheSize = cachedData.size || 0;

                    document.getElementById('cacheStatus').innerHTML =
                        `緩存: ${formatBytes(cacheSize)}<br/>更新時間: ${formatTime(cachedData.timestamp)} ${isExpired ? '(已過期)' : ''}`;

                    document.getElementById('cache-size').textContent = formatBytes(cacheSize, 1);
                    cacheInfo.style.display = 'flex';

                    // 如果緩存未過期，建議從緩存載入
                    if (!isExpired) {
                        const loadBtn = document.getElementById('loadDataBtn');
                        loadBtn.innerHTML = '<i class="fas fa-download"></i> 從網絡載入新資料';
                        loadBtn.title = '緩存資料可用，點擊從網絡獲取最新資料';
                    }
                } else {
                    cacheInfo.style.display = 'none';
                }
            };

            request.onerror = function (event) {
                console.error('檢查緩存狀態失敗:', event.target.error);
            };
        }

        // 保存資料到 IndexedDB
        async function saveToIndexedDB(data) {
            return new Promise((resolve, reject) => {
                if (!db) {
                    reject('IndexedDB 未初始化');
                    return;
                }

                const transaction = db.transaction([STORE_NAME], 'readwrite');
                const store = transaction.objectStore(STORE_NAME);

                // 計算資料大小
                const jsonString = JSON.stringify(data);
                const size = new Blob([jsonString]).size;

                const cacheItem = {
                    key: CACHE_KEY,
                    data: data,
                    timestamp: Date.now(),
                    size: size
                };

                const request = store.put(cacheItem);

                request.onsuccess = function () {
                    console.log('資料成功保存到 IndexedDB');
                    document.getElementById('cache-size').textContent = formatBytes(size, 1);
                    resolve();
                };

                request.onerror = function (event) {
                    console.error('保存到 IndexedDB 失敗:', event.target.error);
                    reject(event.target.error);
                };
            });
        }

        // 從 IndexedDB 載入緩存資料
        async function loadFromCache() {
            return new Promise((resolve, reject) => {
                if (!db) {
                    reject('IndexedDB 未初始化');
                    return;
                }

                const transaction = db.transaction([STORE_NAME], 'readonly');
                const store = transaction.objectStore(STORE_NAME);
                const request = store.get(CACHE_KEY);

                request.onsuccess = function (event) {
                    const cachedData = event.target.result;

                    if (cachedData && cachedData.data) {
                        const cacheAge = Date.now() - cachedData.timestamp;

                        if (cacheAge > CACHE_TTL) {
                            reject('緩存已過期');
                            showNotification('緩存資料已過期，請從網絡載入新資料', 'warning');
                        } else {
                            processData(cachedData.data);
                            showNotification(`成功從緩存載入 ${fehdData.length} 筆設施資料`, 'success');
                            resolve(cachedData.data);
                        }
                    } else {
                        reject('沒有緩存資料');
                    }
                };

                request.onerror = function (event) {
                    console.error('從 IndexedDB 載入失敗:', event.target.error);
                    reject(event.target.error);
                };
            });
        }

        // 清除 IndexedDB 緩存
        async function clearCache() {
            return new Promise((resolve, reject) => {
                if (!db) {
                    reject('IndexedDB 未初始化');
                    return;
                }

                const transaction = db.transaction([STORE_NAME], 'readwrite');
                const store = transaction.objectStore(STORE_NAME);
                const request = store.clear();

                request.onsuccess = function () {
                    console.log('IndexedDB 緩存已清除');
                    document.getElementById('cacheInfo').style.display = 'none';
                    document.getElementById('cache-size').textContent = '0 KB';
                    showNotification('緩存已成功清除', 'success');
                    resolve();
                };

                request.onerror = function (event) {
                    console.error('清除緩存失敗:', event.target.error);
                    showNotification('清除緩存失敗', 'error');
                    reject(event.target.error);
                };
            });
        }

        // 計算 IndexedDB 使用大小
        async function getCacheSize() {
            return new Promise((resolve, reject) => {
                if (!db) {
                    resolve(0);
                    return;
                }

                const transaction = db.transaction([STORE_NAME], 'readonly');
                const store = transaction.objectStore(STORE_NAME);
                const request = store.get(CACHE_KEY);

                request.onsuccess = function (event) {
                    const cachedData = event.target.result;
                    resolve(cachedData ? (cachedData.size || 0) : 0);
                };

                request.onerror = function () {
                    resolve(0);
                };
            });
        }

        // 格式化位元組大小
        function formatBytes(bytes, decimals = 2) {
            if (bytes === 0) return '0 Bytes';

            const k = 1024;
            const dm = decimals < 0 ? 0 : decimals;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];

            const i = Math.floor(Math.log(bytes) / Math.log(k));

            return parseFloat((bytes / Math.pow(k, i)).toFixed(dm)) + ' ' + sizes[i];
        }

        // 格式化時間
        function formatTime(timestamp) {
            const date = new Date(timestamp);
            return date.toLocaleTimeString('zh-HK', {
                hour: '2-digit',
                minute: '2-digit'
            }) + ' ' + date.toLocaleDateString('zh-HK');
        }

        // 初始化地圖
        function initializeMap() {
            // 設定香港的預設中心位置（中環）
            map = L.map('map').setView([22.3193, 114.1694], 11);

            // 添加OpenStreetMap圖層
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
                maxZoom: 18,
            }).addTo(map);

            // 初始化標記圖層
            markerLayer = L.layerGroup().addTo(map);

            // 添加地圖控制
            L.control.scale().addTo(map);
        }

        // 更新最後更新時間
        function updateLastUpdatedTime() {
            const now = new Date();
            const formattedTime = now.toLocaleString('zh-HK', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                hour12: false
            });
            document.getElementById('last-updated').textContent = formattedTime;
        }

        // 清除資料
        function clearData() {
            fehdData = [];
            districtsSet.clear();
            typesSet.clear();
            updateStatistics();

            // 清除地圖標記
            if (markerLayer) {
                markerLayer.clearLayers();
            }
            currentMarker = null;

            const container = document.getElementById('accordion-container');
            container.innerHTML = '<div class="no-data"><i class="fas fa-building"></i><p>請點擊「載入食環署設施資料」按鈕開始查詢</p></div>';

            document.getElementById('map-info').innerHTML = `
                <h3>地圖提示</h3>
                <div class="map-info-content">
                    等待載入資料... 點擊左側列表中的設施會在地圖上顯示其位置。
                </div>
            `;

            showNotification('已清除顯示資料', 'info');
        }

        // 載入食環署資料
        async function loadFEHDData() {
            // 顯示加載狀態
            const container = document.getElementById('accordion-container');
            container.innerHTML = `
                <div class="loading">
                    <div class="loading-spinner"></div>
                    <p>正在載入食環署設施資料...</p>
                </div>
            `;

            // 禁用按鈕防止重複點擊
            const loadBtn = document.getElementById('loadDataBtn');
            loadBtn.disabled = true;
            loadBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 載入中...';

            // 清除地圖標記
            if (markerLayer) {
                markerLayer.clearLayers();
            }

            try {
                // 首先嘗試從網絡載入
                const response = await fetch(DATA_URL);

                if (!response.ok) {
                    throw new Error(`API請求失敗: ${response.status} ${response.statusText}`);
                }

                const data = await response.json();

                if (!data.features || !Array.isArray(data.features) || data.features.length === 0) {
                    // 如果網絡資料為空，嘗試從緩存載入
                    try {
                        await loadFromCache();
                        showNotification('網絡資料為空，已從緩存載入資料', 'info');
                    } catch (cacheError) {
                        container.innerHTML = `
                            <div class="no-data">
                                <i class="fas fa-exclamation-triangle"></i>
                                <p>沒有找到設施資料</p>
                            </div>
                        `;
                        showNotification('查詢完成，但未找到設施資料', 'info');
                    }
                    return;
                }

                // 處理數據
                processData(data);

                // 保存到 IndexedDB
                try {
                    await saveToIndexedDB(data);
                    console.log('資料已保存到 IndexedDB 緩存');
                } catch (saveError) {
                    console.warn('保存到 IndexedDB 失敗:', saveError);
                    showNotification('資料載入成功，但緩存保存失敗', 'warning');
                }

                showNotification(`成功載入 ${fehdData.length} 筆設施資料`, 'success');

            } catch (error) {
                console.error('載入食環署資料時出錯:', error);

                // 嘗試從緩存載入
                try {
                    showNotification('網絡請求失敗，嘗試從緩存載入...', 'warning');
                    await loadFromCache();
                } catch (cacheError) {
                    container.innerHTML = `
                        <div class="no-data">
                            <i class="fas fa-exclamation-triangle"></i>
                            <p>載入設施資料時出錯</p>
                            <p style="font-size: 0.9rem; margin-top: 10px;">${error.message}</p>
                            <p style="font-size: 0.9rem; margin-top: 5px;">緩存資料也不可用</p>
                        </div>
                    `;
                    showNotification('載入設施資料時出錯，請檢查網絡連接', 'error');
                }
            } finally {
                // 重新啟用按鈕
                loadBtn.disabled = false;
                loadBtn.innerHTML = '<i class="fas fa-download"></i> 從網絡載入新資料';

                // 更新緩存狀態
                checkCacheStatus();
            }
        }

        // 處理資料
        function processData(data) {
            fehdData = data.features || [];
            districtsSet.clear();
            typesSet.clear();

            // 建立分組結構：DATASET_TC -> SEARCH01_TC -> SEARCH02_TC
            const groupedData = {};
            window.groupedDataCache = groupedData; // 暫存用於快速訪問
            window.facilityDataCache = []; // 新增：用於存儲所有設施的參考

            let facilityIndex = 0;
            fehdData.forEach(feature => {
                const props = feature.properties;
                const dataset = props.DATASET_TC || '其他';
                const district = props.SEARCH01_TC || '其他地區';
                const type = props.SEARCH02_TC || '其他類型';

                districtsSet.add(district);
                typesSet.add(type);

                if (!groupedData[dataset]) {
                    groupedData[dataset] = {};
                }

                if (!groupedData[dataset][district]) {
                    groupedData[dataset][district] = {};
                }

                if (!groupedData[dataset][district][type]) {
                    groupedData[dataset][district][type] = [];
                }

                // 添加索引信息到設施數據中
                feature.properties._index = facilityIndex;
                feature.properties._dataset = dataset;
                feature.properties._district = district;
                feature.properties._type = type;

                groupedData[dataset][district][type].push(feature);
                window.facilityDataCache.push(feature);

                facilityIndex++;
            });

            // 更新介面
            updateFacilityList(groupedData);
            updateStatistics();
            updateLastUpdatedTime();
        }
        // 更新統計數據
        function updateStatistics() {
            document.getElementById('total-facilities').textContent = fehdData.length;
            document.getElementById('total-districts').textContent = districtsSet.size;
            document.getElementById('total-types').textContent = typesSet.size;

            // 更新緩存大小顯示
            getCacheSize().then(size => {
                document.getElementById('cache-size').textContent = formatBytes(size, 1);
            });
        }

        // 更新設施列表
        function updateFacilityList(groupedData) {
            const container = document.getElementById('accordion-container');

            if (fehdData.length === 0) {
                container.innerHTML = '<div class="no-data"><i class="fas fa-building"></i><p>沒有設施資料</p></div>';
                return;
            }

            let accordionHTML = '';
            let datasetIndex = 0;

            for (const dataset in groupedData) {
                accordionHTML += `
                    <div class="facility-group" data-dataset="${dataset}">
                        <div class="facility-header" onclick="toggleDataset(${datasetIndex})">
                            <div>
                                <i class="fas fa-layer-group" style="margin-right: 8px;"></i>
                                <span>${dataset}</span>
                            </div>
                            <i class="fas fa-chevron-down"></i>
                        </div>
                        <div id="dataset-${datasetIndex}" class="facility-content" style="display: none;">
                `;

                for (const district in groupedData[dataset]) {
                    accordionHTML += `
                        <div class="facility-group" data-district="${district}">
                            <div class="facility-header" onclick="toggleDistrict(${datasetIndex}, '${district}')">
                                <div>
                                    <i class="fas fa-map-marker-alt" style="margin-right: 8px;"></i>
                                    <span>${district}</span>
                                </div>
                                <i class="fas fa-chevron-down"></i>
                            </div>
                            <div id="district-${datasetIndex}-${district}" class="facility-content" style="display: none;">
                    `;

                    for (const type in groupedData[dataset][district]) {
                        const facilities = groupedData[dataset][district][type];

                        accordionHTML += `
                            <div class="facility-group" data-type="${type}">
                                <div class="facility-header" onclick="toggleType(${datasetIndex}, '${district}', '${type}')">
                                    <div>
                                        <i class="fas fa-tag" style="margin-right: 8px;"></i>
                                        <span>${type} (${facilities.length})</span>
                                    </div>
                                    <i class="fas fa-chevron-down"></i>
                                </div>
                                <div id="type-${datasetIndex}-${district}-${type}" class="facility-content" style="display: none;">
                                    <div class="facility-list">
                        `;

                        facilities.forEach((facility, index) => {
                            const props = facility.properties;
                            const lat = props.LATITUDE ? parseFloat(props.LATITUDE) : null;
                            const lng = props.LONGITUDE ? parseFloat(props.LONGITUDE) : null;
                            const hasCoordinates = lat && lng && !isNaN(lat) && !isNaN(lng);

                            // console.log(`${datasetIndex}, '${district}', '${type}', ${index}`)

                            accordionHTML += `
                                <div class="facility-item" onclick="selectFacility(${datasetIndex}, '${district}', '${type}', ${index})" 
                                     data-lat="${hasCoordinates ? lat : ''}" 
                                     data-lng="${hasCoordinates ? lng : ''}">
                                    <div class="facility-meta">
                                        <span class="facility-badge badge-district">
                                            <i class="fas fa-map-marker-alt" style="margin-right: 4px;"></i>
                                            ${district}
                                        </span>
                                        <span class="facility-badge badge-type">
                                            <i class="fas fa-tag" style="margin-right: 4px;"></i>
                                            ${type}
                                        </span>
                                        ${props.NSEARCH01_TC ? `<span class="facility-badge badge-phone">
                                            <i class="fas fa-phone" style="margin-right: 4px;"></i>
                                            ${props.NSEARCH01_TC}
                                        </span>` : ''}
                                        ${props.NSEARCH04_TC ? `<span class="facility-badge badge-hours">
                                            <i class="far fa-clock" style="margin-right: 4px;"></i>
                                            ${props.NSEARCH04_TC}
                                        </span>` : ''}
                                        <span class="facility-badge badge-cached">
                                            <i class="fas fa-database" style="margin-right: 4px;"></i>
                                            已緩存
                                        </span>
                                    </div>
                                    <div class="facility-info">
                                        <div>
                                            <div class="facility-row">
                                                <div class="facility-label">設施名稱:</div>
                                                <div class="facility-value">${props.NAME_TC || '未命名'}</div>
                                            </div>
                                            <div class="facility-row">
                                                <div class="facility-label">地址:</div>
                                                <div class="facility-value">${props.ADDRESS_TC || '地址不詳'}</div>
                                            </div>
                                        </div>
                                        <div>
                                            <div class="facility-row">
                                                <div class="facility-label">緯度:</div>
                                                <div class="facility-value">${lat ? lat.toFixed(6) : 'N/A'}</div>
                                            </div>
                                            <div class="facility-row">
                                                <div class="facility-label">經度:</div>
                                                <div class="facility-value">${lng ? lng.toFixed(6) : 'N/A'}</div>
                                            </div>
                                        </div>
                                    </div>
                                    ${hasCoordinates ? '<p style="color: #14b8a6; font-size: 0.8rem; margin-top: 8px;"><i class="fas fa-map-marker-alt"></i> 點擊此項目查看地圖位置</p>' : ''}
                                </div>
                            `;
                        });

                        accordionHTML += `
                                    </div>
                                </div>
                            </div>
                        `;
                    }

                    accordionHTML += `
                            </div>
                        </div>
                    `;
                }

                accordionHTML += `
                        </div>
                    </div>
                `;

                datasetIndex += 1;
            }

            container.innerHTML = accordionHTML;
        }

        // 選擇設施（在地圖上顯示）
        function selectFacility(datasetIndex, district, type, index) {
            // 清除之前選中的樣式
            document.querySelectorAll('.facility-item').forEach(item => {
                item.classList.remove('selected');
            });

            // 獲取設施資料
            const props = getFacilityProperties(datasetIndex, district, type, index);

            if (!props) {
                showNotification('無法找到設施資料', 'error');
                return;
            }

            const lat = props.LATITUDE ? parseFloat(props.LATITUDE) : null;
            const lng = props.LONGITUDE ? parseFloat(props.LONGITUDE) : null;

            if (!lat || !lng || isNaN(lat) || isNaN(lng)) {
                showNotification('此設施沒有有效的地理位置資訊', 'info');
                return;
            }

            // 查找對應的列表項目並添加選中樣式
            // 使用更可靠的方法查找對應的列表項目
            const facilityItems = document.querySelectorAll('.facility-item');
            let foundItem = null;

            facilityItems.forEach(item => {
                const itemLat = item.getAttribute('data-lat');
                const itemLng = item.getAttribute('data-lng');
                const itemName = item.querySelector('.facility-value:first-child')?.textContent;

                if (itemLat && itemLng && itemName) {
                    const itemLatNum = parseFloat(itemLat);
                    const itemLngNum = parseFloat(itemLng);

                    // 比較座標和名稱來找到對應的項目
                    if (Math.abs(itemLatNum - lat) < 0.000001 &&
                        Math.abs(itemLngNum - lng) < 0.000001 &&
                        itemName.trim() === (props.NAME_TC || '未命名').trim()) {
                        foundItem = item;
                        item.classList.add('selected');
                    }
                }
            });

            // 清除之前的標記
            if (markerLayer) {
                markerLayer.clearLayers();
            }

            // 添加新標記
            currentMarker = L.marker([lat, lng]).addTo(markerLayer);

            // 創建彈出視窗內容
            const popupContent = createPopupContent(props, district, type, lat, lng);
            currentMarker.bindPopup(popupContent).openPopup();

            // 移動地圖視圖到標記位置
            map.setView([lat, lng], 16);

            // 更新地圖資訊
            updateMapInfo(props, district, type);
        }

        // 獲取設施屬性
        function getFacilityProperties(datasetIndex, district, type, index) {
            if (!window.groupedDataCache) {
                console.error('Grouped data cache not found');
                return null;
            }

            // 將 datasetIndex 轉換為實際的 dataset 名稱
            let currentIndex = 0;
            let targetDataset = null;

            // 先找到對應的 dataset
            for (const dataset in window.groupedDataCache) {
                if (currentIndex === datasetIndex) {
                    targetDataset = dataset;
                    break;
                }
                currentIndex++;
            }

            if (!targetDataset ||
                !window.groupedDataCache[targetDataset] ||
                !window.groupedDataCache[targetDataset][district] ||
                !window.groupedDataCache[targetDataset][district][type]) {
                console.error('Data structure not found for:', { datasetIndex, district, type });
                return null;
            }

            const facilities = window.groupedDataCache[targetDataset][district][type];

            if (!facilities || !facilities[index]) {
                console.error('Facility not found at index:', index);
                return null;
            }

            return facilities[index].properties;
        }

        // 創建彈出視窗內容
        function createPopupContent(props, district, type, lat, lng) {
            return `
        <div style="max-width: 300px;">
            <h3 style="margin: 0 0 10px 0; color: #0f766e; font-size: 16px;">
                ${props.NAME_TC || '未命名'}
            </h3>
            <div style="margin-bottom: 8px;">
                <strong style="color: #374151;">地址:</strong> 
                ${props.ADDRESS_TC || '地址不詳'}
            </div>
            <div style="margin-bottom: 8px;">
                <strong style="color: #374151;">地區:</strong> 
                <span style="color: #065f46; background: #d1fae5; padding: 2px 8px; border-radius: 4px; font-size: 12px;">
                    ${district}
                </span>
            </div>
            <div style="margin-bottom: 8px;">
                <strong style="color: #374151;">類型:</strong> 
                <span style="color: #166534; background: #dcfce7; padding: 2px 8px; border-radius: 4px; font-size: 12px;">
                    ${type}
                </span>
            </div>
            ${props.NSEARCH01_TC ? `
                <div style="margin-bottom: 8px;">
                    <strong style="color: #374151;">電話:</strong> 
                    <span style="color: #1e40af; background: #dbeafe; padding: 2px 8px; border-radius: 4px; font-size: 12px;">
                        <i class="fas fa-phone" style="margin-right: 4px;"></i>${props.NSEARCH01_TC}
                    </span>
                </div>
            ` : ''}
            ${props.NSEARCH04_TC ? `
                <div style="margin-bottom: 8px;">
                    <strong style="color: #374151;">開放時間:</strong> 
                    <span style="color: #92400e; background: #fef3c7; padding: 2px 8px; border-radius: 4px; font-size: 12px;">
                        <i class="far fa-clock" style="margin-right: 4px;"></i>${props.NSEARCH04_TC}
                    </span>
                </div>
            ` : ''}
            <div style="margin-bottom: 8px;">
                <strong style="color: #374151;">座標:</strong> 
                <span style="font-family: monospace; font-size: 12px;">
                    ${lat.toFixed(6)}, ${lng.toFixed(6)}
                </span>
            </div>
            ${props.LASTUPDATE ? `
                <div style="margin-bottom: 8px;">
                    <strong style="color: #374151;">最後更新:</strong> ${props.LASTUPDATE}
                </div>
            ` : ''}
            <div style="margin-top: 12px; padding-top: 8px; border-top: 1px solid #e5e7eb; font-size: 11px; color: #6b7280;">
                <i class="fas fa-database" style="margin-right: 4px;"></i>資料來源: IndexedDB 緩存
            </div>
        </div>
    `;
        }

        // 更新地圖資訊
        function updateMapInfo(props, district, type) {
            const mapInfo = document.getElementById('map-info');

            let content = `
                <h3>${props.NAME_TC || '未命名設施'}</h3>
                <div class="map-info-content">
                    <p><strong>地址:</strong> ${props.ADDRESS_TC || '地址不詳'}</p>
                    <p><strong>地區:</strong> ${district}</p>
                    <p><strong>設施類型:</strong> ${type}</p>
            `;

            if (props.NSEARCH01_TC) {
                content += `<p><strong>聯絡電話:</strong> ${props.NSEARCH01_TC}</p>`;
            }

            if (props.NSEARCH04_TC) {
                content += `<p><strong>開放時間:</strong> ${props.NSEARCH04_TC}</p>`;
            }

            if (props.LATITUDE && props.LONGITUDE) {
                const lat = parseFloat(props.LATITUDE);
                const lng = parseFloat(props.LONGITUDE);
                content += `<p><strong>座標:</strong> ${lat.toFixed(6)}, ${lng.toFixed(6)}</p>`;
            }

            content += `
                <p><strong>最後更新:</strong> ${props.LASTUPDATE || '不詳'}</p>
                <p><strong>資料來源:</strong> IndexedDB 緩存</p>
            </div>`;

            mapInfo.innerHTML = content;
        }

        // 切摺疊資料集
        function toggleDataset(index) {
            const content = document.getElementById(`dataset-${index}`);
            const header = content.previousElementSibling;
            const icon = header.querySelector('.fa-chevron-down, .fa-chevron-up');

            if (content.style.display === 'none') {
                content.style.display = 'block';
                header.classList.add('active');
                icon.className = 'fas fa-chevron-up';
            } else {
                content.style.display = 'none';
                header.classList.remove('active');
                icon.className = 'fas fa-chevron-down';
            }
        }

        // 切摺疊地區
        function toggleDistrict(datasetIndex, district) {
            const content = document.getElementById(`district-${datasetIndex}-${district}`);
            const header = content.previousElementSibling;
            const icon = header.querySelector('.fa-chevron-down, .fa-chevron-up');

            if (content.style.display === 'none') {
                content.style.display = 'block';
                header.classList.add('active');
                icon.className = 'fas fa-chevron-up';
            } else {
                content.style.display = 'none';
                header.classList.remove('active');
                icon.className = 'fas fa-chevron-down';
            }
        }

        // 切摺疊類型
        function toggleType(datasetIndex, district, type) {
            const content = document.getElementById(`type-${datasetIndex}-${district}-${type}`);
            const header = content.previousElementSibling;
            const icon = header.querySelector('.fa-chevron-down, .fa-chevron-up');

            if (content.style.display === 'none') {
                content.style.display = 'block';
                header.classList.add('active');
                icon.className = 'fas fa-chevron-up';
            } else {
                content.style.display = 'none';
                header.classList.remove('active');
                icon.className = 'fas fa-chevron-down';
            }
        }

        // 縮放到香港全境
        function zoomToHongKong() {
            if (map) {
                map.setView([22.3193, 114.1694], 11);
                showNotification('已縮放到香港全境', 'info');
            }
        }

        // 顯示通知
        function showNotification(message, type = 'info') {
            // 移除現有通知
            const existingNotification = document.querySelector('.notification');
            if (existingNotification) {
                existingNotification.remove();
            }

            // 創建通知元素
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.innerHTML = `
                <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : type === 'warning' ? 'exclamation-triangle' : 'info-circle'}"></i>
                <span>${message}</span>
            `;

            // 添加到文檔
            document.body.appendChild(notification);

            // 3秒後移除
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease-out';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        // 初始化教程
        if (!localStorage.getItem('fehdTutorialShown')) {
            setTimeout(() => {
                alert("歡迎使用「食環署的設施及服務位置」查詢系統！\n\n• 點擊「載入食環署設施資料」從網絡載入最新資料\n• 系統會自動使用 IndexedDB 緩存資料以提升性能\n• 緩存資料有效期限為24小時\n• 點擊「從緩存載入」快速載入本地資料\n• 點擊「清除緩存」可刪除所有本地緩存資料\n• 點擊設施項目查看詳細資訊並在地圖顯示位置");
                localStorage.setItem('fehdTutorialShown', 'true');
            }, 1000);
        }
    </script>
</body>

</html>
